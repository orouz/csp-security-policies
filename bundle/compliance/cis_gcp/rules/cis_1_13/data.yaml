metadata:
  id: 5f2af75e-e09c-57dd-8279-2017fb81f5cb
  name: Ensure API Keys Are Restricted To Use by Only Specified Hosts and Apps
  profile_applicability: '* Level 2'
  description: |-
    API Keys should only be used for services in cases where other authentication methods are unavailable.
    In this case, unrestricted keys are insecure because they can be viewed publicly, such as from within a browser, or they can be accessed on a device where the key resides.
    It is recommended to restrict API key usage to trusted hosts, HTTP referrers and apps.
    It is recommended to use the more secure standard authentication flow instead.
  rationale: |-
    Security risks involved in using API-Keys appear below:

    - API keys are simple encrypted strings

    - API keys do not identify the user or the application making the API request

    - API keys are typically accessible to clients, making it easy to discover and steal an API key

    In light of these potential risks, Google recommends using the standard authentication flow instead of API keys.
    However, there are limited cases where API keys are more appropriate.
    For example, if there is a mobile application that needs to use the Google Cloud Translation API, but doesn't otherwise need a backend server, API keys are the simplest way to authenticate to that API.

    In order to reduce attack vectors, API-Keys can be restricted only to trusted hosts, HTTP referrers and applications.
  audit: |-
    **From Google Cloud Console**

    1. Go to `APIs & Services\Credentials` using `https://console.cloud.google.com/apis/credentials`

    2. In the section `API Keys`, Click the `API Key Name`. The API Key properties display on a new page.

    3. For every API Key, ensure the section `Key restrictions` parameter `Application restrictions` is not set to `None`.

    Or,

    4. Ensure `Application restrictions` is set to `HTTP referrers` and the referrer is not set to wild-cards `(* or *.[TLD] or *.[TLD]/*) allowing access to any/wide HTTP referrer(s)`

    Or,

    5. Ensure `Application restrictions` is set to `IP addresses` and referrer is not set to `any host (0.0.0.0 or 0.0.0.0/0 or ::0)`

    **From Google Cloud Command Line**

    6. Run the following from within the project you wish to audit 
    ```
    gcloud services api-keys list --filter="-restrictions:*" --format="table[box](displayName:label='Key With No Restrictions')
    ```
  remediation: |-
    **From Google Cloud Console**

    ***Leaving Keys in Place***

    1. Go to `APIs & Services\Credentials` using `https://console.cloud.google.com/apis/credentials`

    2. In the section `API Keys`, Click the `API Key Name`. The API Key properties display on a new page.

    3. In the `Key restrictions` section, set the application restrictions to any of `HTTP referrers, IP addresses, Android apps, iOS apps`.

    4. Click `Save`.

    5. Repeat steps 2,3,4 for every unrestricted API key.
    **Note:** Do not set `HTTP referrers` to wild-cards (* or *.[TLD] or *.[TLD]/*) allowing access to any/wide HTTP referrer(s)
    Do not set `IP addresses` and referrer to `any host (0.0.0.0 or 0.0.0.0/0 or ::0)`

    ***Removing Keys***

    Another option is to remove the keys entirely.

    6. Go to `APIs & Services\Credentials` using `https://console.cloud.google.com/apis/credentials`

    7. In the section `API Keys`, select the checkbox next to each key you wish to remove

    8. Select `Delete` and confirm.
  impact: |-
    Setting `Application Restrictions` may break existing application functioning, if not done carefully.
  default_value: ''
  references: |-
    1. https://cloud.google.com/docs/authentication/api-keys
    2. https://cloud.google.com/sdk/gcloud/reference/services/api-keys/list
    3. https://cloud.google.com/sdk/gcloud/reference/alpha/services/api-keys/update
  section: Identity and Access Management
  version: '1.0'
  tags:
  - CIS
  - GCP
  - CIS 1.13
  - Identity and Access Management
  benchmark:
    name: CIS Google Cloud Platform Foundation
    version: v2.0.0
    id: cis_gcp
    rule_number: '1.13'
    posture_type: cspm
